<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Smart E-Book</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#121214">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.min.js"></script>
    <script src="https://unpkg.com/@panzoom/panzoom@4.5.1/dist/panzoom.min.js"></script>
    
    <style>
        :root { --bg-color: #1e1e20; --ui-bg: rgba(30, 30, 30, 0.9); --accent: #64c8ff; --text: #ffffff; }
        
        body { margin: 0; padding: 0; background-color: var(--bg-color); color: var(--text); font-family: 'Pretendard', 'Malgun Gothic', sans-serif; overflow: hidden; height: 100vh; width: 100vw; display: flex; flex-direction: column; }
        
        #book-container { flex: 1; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; z-index: 1; }
        #book-container:fullscreen { background-color: var(--bg-color); width: 100vw; height: 100vh; } 
        
        /* ì±… ê·¸ë¦¼ì ë° ì…ì²´ê° ê°•í™” */
        .stf__wrapper { box-shadow: 0 10px 40px rgba(0,0,0,0.7); }
        
        #ui-controls { position: fixed; bottom: 0; left: 0; width: 100%; background: linear-gradient(to top, rgba(0,0,0,0.95), transparent); padding: 20px 20px 30px 20px; display: flex; flex-direction: column; gap: 15px; z-index: 10; transition: transform 0.3s ease; box-sizing: border-box; }
        #ui-controls.hidden { transform: translateY(100%); }
        
        .control-row { display: flex; justify-content: space-between; align-items: center; width: 100%; max-width: 800px; margin: 0 auto; box-sizing: border-box; }
        
        #page-slider { width: 100%; height: 6px; -webkit-appearance: none; background: rgba(255,255,255,0.2); border-radius: 3px; outline: none; cursor: pointer; }
        #page-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; background: var(--accent); border-radius: 50%; cursor: pointer; box-shadow: 0 0 10px rgba(100,200,255,0.6); transition: transform 0.1s; }
        #page-slider::-webkit-slider-thumb:hover { transform: scale(1.2); }
        
        #page-info { font-size: 15px; color: #eee; font-weight: 500; font-variant-numeric: tabular-nums; }
        
        .btn-icon { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.15); color: white; border-radius: 6px; padding: 6px 14px; font-size: 14px; cursor: pointer; transition: all 0.2s; }
        .btn-icon:hover { background: rgba(255,255,255,0.25); border-color: rgba(255,255,255,0.4); }

        #start-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .btn-upload { background-color: var(--accent); color: #000; border: none; padding: 16px 40px; font-size: 18px; font-weight: bold; border-radius: 50px; box-shadow: 0 0 30px rgba(100, 200, 255, 0.3); margin-bottom: 20px; cursor: pointer; transition: transform 0.1s; }
        .btn-upload:active { transform: scale(0.96); }
        #loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none; z-index: 90; font-size: 18px; color: var(--accent); background: rgba(0,0,0,0.85); padding: 25px; border-radius: 12px; backdrop-filter: blur(5px); }

        #zoom-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 999; display: none; overflow: hidden; }
        #zoom-container { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
        #zoom-img { max-width: 100%; max-height: 100%; object-fit: contain; }
        #zoom-close-btn { position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.6); color: white; border: 2px solid white; width: 44px; height: 44px; border-radius: 50%; font-size: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 1000; }
        
        .top-btn-group { position: absolute; top: 15px; right: 15px; z-index: 101; display: none; gap: 10px; }
        .top-btn { border: none; color: white; padding: 10px 18px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.2); transition: transform 0.1s; }
        .top-btn:active { transform: scale(0.95); }
        #btn-export { background: linear-gradient(135deg, #6f42c1, #8e44ad); } 
        #btn-reset { background: #ff5252; } 
    </style>
</head>
<body>

    <div class="top-btn-group" id="top-buttons">
        <button id="btn-export" class="top-btn">ğŸ“˜ ì´ë¶ íŒŒì¼ë¡œ ì €ì¥ (ê³µìœ ìš©)</button>
        <button id="btn-reset" class="top-btn">â†» ì´ˆê¸°í™”</button>
    </div>

    <div id="start-screen">
        <h2 style="color:var(--accent); margin-bottom: 10px; font-size: 28px;">Smart Library</h2>
        <p style="color:#aaa; margin-bottom: 40px; font-size: 15px; line-height: 1.5;">
            PC, íƒœë¸”ë¦¿, ëª¨ë°”ì¼ì— ë§ì¶°<br>ìµœì ì˜ ë ˆì´ì•„ì›ƒìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
        </p>
        <input type="file" id="file-input" accept="application/pdf" style="display: none;">
        <button class="btn-upload" onclick="document.getElementById('file-input').click()">PDF ë¶ˆëŸ¬ì˜¤ê¸°</button>
    </div>

    <div id="loading">ë¡œë”© ì¤‘...</div>

    <div id="book-container">
        <div id="flipbook"></div>
    </div>

    <div id="ui-controls">
        <div class="control-row" style="margin-bottom: 10px;">
            <span id="page-info">ì¤€ë¹„ ì¤‘</span>
            <button class="btn-icon" id="btn-fullscreen">ì „ì²´í™”ë©´</button>
        </div>
        <div class="control-row">
            <input type="range" id="page-slider" min="0" max="100" value="0">
        </div>
    </div>

    <div id="zoom-layer">
        <div id="zoom-close-btn">âœ•</div>
        <div id="zoom-container"><img id="zoom-img" src="" alt="Zoom Image"></div>
    </div>

    <script>
        if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js').catch(()=>{});
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // === DB Logic (ìƒëµ ì—†ì´ ì‚¬ìš©) ===
        const DB_NAME = "EbookDB"; const STORE_NAME = "files";
        function openDB(){ return new Promise((res,rej)=>{ const r=indexedDB.open(DB_NAME,1); r.onupgradeneeded=(e)=>e.target.result.createObjectStore(STORE_NAME); r.onsuccess=(e)=>res(e.target.result); r.onerror=(e)=>rej(e); }); }
        async function saveFileToDB(d){ const db=await openDB(); const tx=db.transaction(STORE_NAME,"readwrite"); tx.objectStore(STORE_NAME).put(d,"currentBook"); return new Promise(r=>tx.oncomplete=r); }
        async function loadFileFromDB(){ const db=await openDB(); const tx=db.transaction(STORE_NAME,"readonly"); const r=tx.objectStore(STORE_NAME).get("currentBook"); return new Promise(res=>{r.onsuccess=()=>res(r.result)}); }
        async function clearDB(){ const db=await openDB(); const tx=db.transaction(STORE_NAME,"readwrite"); tx.objectStore(STORE_NAME).delete("currentBook"); return new Promise(r=>tx.oncomplete=r); }

        const els = {
            fileInput: document.getElementById('file-input'),
            startScreen: document.getElementById('start-screen'),
            loading: document.getElementById('loading'),
            bookContainer: document.getElementById('book-container'),
            flipbook: document.getElementById('flipbook'),
            ui: document.getElementById('ui-controls'),
            slider: document.getElementById('page-slider'),
            pageInfo: document.getElementById('page-info'),
            btnFullscreen: document.getElementById('btn-fullscreen'),
            zoomLayer: document.getElementById('zoom-layer'),
            zoomImg: document.getElementById('zoom-img'),
            zoomClose: document.getElementById('zoom-close-btn'),
            topButtons: document.getElementById('top-buttons'),
            btnReset: document.getElementById('btn-reset'),
            btnExport: document.getElementById('btn-export')
        };

        let allPages = [], pageFlip, totalPages = 0, currentPDFData = null, zoomInstance = null, lastTap = 0, pdfOriginalRatio = 0.7;

        // ì‹œì‘ ì‹œ ë¡œë“œ
        window.addEventListener('DOMContentLoaded', async () => {
            const saved = await loadFileFromDB();
            if (saved) { currentPDFData = saved; startViewer(saved.slice(0)); }
        });

        // íŒŒì¼ ì„ íƒ
        els.fileInput.addEventListener('change', async (e) => {
            const f = e.target.files[0]; if(!f) return;
            const d = await f.arrayBuffer();
            currentPDFData = d; await saveFileToDB(d);
            startViewer(d.slice(0));
        });

        function startViewer(data) {
            els.startScreen.style.display='none'; els.loading.style.display='block'; els.topButtons.style.display='flex';
            loadPDF(data);
        }

        els.btnReset.addEventListener('click', async()=>{ if(confirm("ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")){ await clearDB(); location.reload(); } });

        // === [PC/íƒœë¸”ë¦¿ ëŒ€ì‘] ì´ë¶ íŒŒì¼ ë‚´ë³´ë‚´ê¸° ë¡œì§ ===
        els.btnExport.addEventListener('click', () => {
            if (!currentPDFData || currentPDFData.byteLength === 0) return alert("íŒŒì¼ ì˜¤ë¥˜. ë‹¤ì‹œ ì—´ì–´ì£¼ì„¸ìš”.");
            els.loading.style.display = 'block'; els.loading.innerText = "ë°˜ì‘í˜• ì´ë¶ ìƒì„± ì¤‘...";
            
            setTimeout(async () => {
                try {
                    const base64 = await arrayBufferToBase64(currentPDFData);
                    downloadPortableHTML(base64);
                } catch(e) { alert("ì˜¤ë¥˜: "+e.message); }
                els.loading.style.display = 'none';
            }, 100);
        });

        function arrayBufferToBase64(buffer) {
            return new Promise((resolve, reject) => {
                const blob = new Blob([buffer], { type: 'application/pdf' });
                const reader = new FileReader();
                reader.onloadend = () => reader.result ? resolve(reader.result.split(',')[1]) : reject(new Error("Fail"));
                reader.readAsDataURL(blob);
            });
        }

        // ============================================================
        // [í•µì‹¬] ìƒì„±ë  HTML í…œí”Œë¦¿ (ë°˜ì‘í˜• ë¡œì§ í¬í•¨)
        // ============================================================
        function downloadPortableHTML(base64Data) {
            // í˜„ì¬ í˜ì´ì§€ì˜ ìŠ¤íƒ€ì¼ê³¼ ìŠ¤í¬ë¦½íŠ¸ ë¡œì§ì„ ê·¸ëŒ€ë¡œ ê°€ì ¸ì˜¤ë˜, ì´ˆê¸°í™” ë¡œì§ë§Œ ìˆ˜ì •
            const htmlContent = `<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My E-Book</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"><\/script>
    <script src="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.min.js"><\/script>
    <script src="https://unpkg.com/@panzoom/panzoom@4.5.1/dist/panzoom.min.js"><\/script>
    <style>
        ${document.querySelector('style').innerHTML}
        #start-screen, .top-btn-group { display: none !important; }
    </style>
</head>
<body>
    <div id="loading">ì±…ì„ í¼ì¹˜ëŠ” ì¤‘...</div>
    <div id="book-container"><div id="flipbook"></div></div>
    <div id="ui-controls">
        <div class="control-row" style="margin-bottom:10px;">
            <span id="page-info">0 / 0</span>
            <button class="btn-icon" id="btn-fullscreen">ì „ì²´í™”ë©´</button>
        </div>
        <div class="control-row"><input type="range" id="page-slider" min="0" max="100" value="0"></div>
    </div>
    <div id="zoom-layer">
        <div id="zoom-close-btn">âœ•</div>
        <div id="zoom-container"><img id="zoom-img" src=""></div>
    </div>
    <script>
        const embeddedPDF = "${base64Data}";
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        window.addEventListener('DOMContentLoaded', () => {
            if(!embeddedPDF) return alert("ë°ì´í„° ì—†ìŒ");
            const bin = window.atob(embeddedPDF);
            const len = bin.length; const bytes = new Uint8Array(len);
            for (let i=0; i<len; i++) bytes[i] = bin.charCodeAt(i);
            loadPDF(bytes.buffer);
        });

        // ---------------------------------------------------------
        //  [ë°˜ì‘í˜• ë·°ì–´ ë¡œì§ ë³µì‚¬ë¨]
        // ---------------------------------------------------------
        const els = {
            loading: document.getElementById('loading'),
            bookContainer: document.getElementById('book-container'),
            flipbook: document.getElementById('flipbook'),
            ui: document.getElementById('ui-controls'),
            slider: document.getElementById('page-slider'),
            pageInfo: document.getElementById('page-info'),
            btnFullscreen: document.getElementById('btn-fullscreen'),
            zoomLayer: document.getElementById('zoom-layer'),
            zoomImg: document.getElementById('zoom-img'),
            zoomClose: document.getElementById('zoom-close-btn')
        };
        
        let allPages=[], pageFlip, totalPages=0, lastTap=0, zoomInstance=null, pdfOriginalRatio=0.7;

        function splitCanvas(original) {
            const w=original.width, h=original.height, halfW=Math.floor(w/2);
            const l=document.createElement('canvas'), r=document.createElement('canvas');
            l.width=halfW; l.height=h; r.width=halfW; r.height=h;
            l.getContext('2d').drawImage(original,0,0,halfW,h,0,0,halfW,h);
            r.getContext('2d').drawImage(original,halfW,0,halfW,h,0,0,halfW,h);
            return [l,r];
        }

        async function loadPDF(data) {
            try {
                const pdfDoc = await pdfjsLib.getDocument(data).promise;
                const fragment = document.createDocumentFragment();
                const firstPage = await pdfDoc.getPage(1);
                const firstViewport = firstPage.getViewport({scale:1.0});
                pdfOriginalRatio = (firstViewport.width>firstViewport.height*1.1)?(firstViewport.width/2)/firstViewport.height : firstViewport.width/firstViewport.height;

                for(let i=1; i<=pdfDoc.numPages; i++){
                    const page = await pdfDoc.getPage(i);
                    // PCì—ì„œ ê¹¨ì§€ì§€ ì•Šê²Œ í™”ì§ˆ 2.0ìœ¼ë¡œ ìƒí–¥
                    const viewport = page.getViewport({scale:2.0});
                    const canvas = document.createElement('canvas');
                    canvas.width=viewport.width; canvas.height=viewport.height;
                    await page.render({canvasContext:canvas.getContext('2d'), viewport}).promise;
                    
                    if(viewport.width > viewport.height*1.1){
                        const [l,r] = splitCanvas(canvas);
                        l.classList.add('page-canvas'); r.classList.add('page-canvas');
                        l.dataset.pdfIdx=i; r.dataset.pdfIdx=i;
                        allPages.push(l); allPages.push(r);
                        fragment.appendChild(l); fragment.appendChild(r);
                    } else {
                        canvas.classList.add('page-canvas'); canvas.dataset.pdfIdx=i;
                        allPages.push(canvas); fragment.appendChild(canvas);
                    }
                    els.loading.innerText = 'ë³€í™˜ ì¤‘... ('+i+'/'+pdfDoc.numPages+')';
                }
                els.flipbook.appendChild(fragment);
                els.loading.style.display='none';
                initFlipBook();
            } catch(e) { alert('ì˜¤ë¥˜: '+e.message); }
        }

        // === [í•µì‹¬] ë°˜ì‘í˜• ì´ˆê¸°í™” í•¨ìˆ˜ ===
        function initFlipBook() {
            const isLandscape = window.innerWidth > window.innerHeight; // ê°€ë¡œ ëª¨ë“œ ì—¬ë¶€ í™•ì¸
            
            // ì—¬ë°±: PC/ê°€ë¡œëª¨ë“œëŠ” ì¡°ê¸ˆ ë” ì—¬ìœ ìˆê²Œ
            const padding = isLandscape ? 60 : 30;
            const containerW = els.bookContainer.clientWidth - padding;
            const containerH = els.bookContainer.clientHeight - padding;

            let bookH = containerH;
            let bookW = 0;

            // [ë¡œì§ ë¶„ê¸°]
            if (isLandscape) {
                // ê°€ë¡œ ëª¨ë“œ (PC/íƒœë¸”ë¦¿): ë‘ í˜ì´ì§€ ë³´ê¸° (Spread)
                // ì „ì²´ ë„ˆë¹„ = (ë†’ì´ * í˜ì´ì§€ë¹„ìœ¨) * 2
                bookW = (bookH * pdfOriginalRatio) * 2;
                
                // ë§Œì•½ ê³„ì‚°ëœ ë„ˆë¹„ê°€ í™”ë©´ë³´ë‹¤ í¬ë©´ ë„ˆë¹„ ê¸°ì¤€ìœ¼ë¡œ ë†’ì´ ì¤„ì„
                if (bookW > containerW) {
                    bookW = containerW;
                    bookH = (bookW / 2) / pdfOriginalRatio;
                }
            } else {
                // ì„¸ë¡œ ëª¨ë“œ (ëª¨ë°”ì¼): í•œ í˜ì´ì§€ ë³´ê¸°
                bookW = bookH * pdfOriginalRatio;
                if (bookW > containerW) {
                    bookW = containerW;
                    bookH = bookW / pdfOriginalRatio;
                }
            }

            bookW = Math.floor(bookW); bookH = Math.floor(bookH);

            pageFlip = new St.PageFlip(els.flipbook, {
                width: bookW, 
                height: bookH, 
                size: 'fixed', 
                // [ì¤‘ìš”] ê°€ë¡œ ëª¨ë“œë©´ false(ë‘ ìª½), ì„¸ë¡œ ëª¨ë“œë©´ true(í•œ ìª½)
                usePortrait: !isLandscape, 
                maxShadowOpacity: 0.5, 
                autoSize: true,
                showCover: true // í‘œì§€ ë‹¨ë… ë³´ê¸° í™œì„±í™”
            });

            pageFlip.loadFromHTML(allPages);
            totalPages = pageFlip.getPageCount();
            els.slider.max = totalPages-1;

            pageFlip.on('flip', (e)=>{ 
                els.pageInfo.innerText = (e.data+1)+' / '+totalPages; 
                els.slider.value=e.data; 
            });
            
            els.slider.addEventListener('input', (e)=>pageFlip.flip(parseInt(e.target.value)));
            
            // ì´ë²¤íŠ¸ ì—°ê²°
            els.bookContainer.addEventListener('touchend', handleTouch);
            els.bookContainer.addEventListener('click', handleTouch);
        }
        
        // [PC ì „ìš©] í‚¤ë³´ë“œ í™”ì‚´í‘œ ë„˜ê¹€ ê¸°ëŠ¥ ì¶”ê°€
        document.addEventListener('keydown', (e) => {
            if (!pageFlip) return;
            if (e.key === "ArrowRight") pageFlip.flipNext();
            if (e.key === "ArrowLeft") pageFlip.flipPrev();
        });

        function handleTouch(e) {
            if (e.target.closest('#ui-controls')) return;
            const currentTime = new Date().getTime();
            if (currentTime - lastTap < 300 && currentTime - lastTap > 0) { openZoomView(); e.preventDefault(); } 
            else { setTimeout(() => { if (new Date().getTime() - lastTap > 350) els.ui.classList.toggle('hidden'); }, 350); }
            lastTap = currentTime;
        }

        function openZoomView() {
            const currentIdx = pageFlip.getCurrentPageIndex();
            const currentPage = allPages[currentIdx];
            if (currentPage) {
                els.zoomImg.src = currentPage.toDataURL();
                els.zoomLayer.style.display = 'block';
                if (zoomInstance) zoomInstance.dispose();
                zoomInstance = Panzoom(document.getElementById('zoom-container'), { maxScale: 5, minScale: 1, contain: 'outside' });
                document.getElementById('zoom-container').addEventListener('wheel', zoomInstance.zoomWithWheel);
            }
        }
        els.zoomClose.addEventListener('click', () => { els.zoomLayer.style.display = 'none'; if(zoomInstance) zoomInstance.dispose(); });
        
        els.btnFullscreen.addEventListener('click', () => {
            if (!document.fullscreenElement) { document.documentElement.requestFullscreen(); els.btnFullscreen.innerText = "ì¶•ì†Œ"; }
            else { if(document.exitFullscreen) document.exitFullscreen(); els.btnFullscreen.innerText = "ì „ì²´í™”ë©´"; }
        });

        // ë¦¬ì‚¬ì´ì¦ˆ ì‹œ (ê°€ë¡œ/ì„¸ë¡œ íšŒì „ í¬í•¨) ë·°ì–´ ì¬ì„¤ì •
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => { 
                 if(pageFlip){ 
                    const idx=pageFlip.getCurrentPageIndex(); pageFlip.destroy(); 
                    els.flipbook.innerHTML=''; allPages.forEach(p=>els.flipbook.appendChild(p)); 
                    initFlipBook(); 
                    // í˜ì´ì§€ ë³µêµ¬ ì‹œ ë²”ìœ„ ì²´í¬
                    if(idx < pageFlip.getPageCount()) pageFlip.turnToPage(idx); 
                }
            }, 500);
        });
    <\/script>
</body>
</html>`;

            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'My_Responsive_Book.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ============================================================
        // ë·°ì–´ ë‚´ë¶€ ë¡œì§ (Parent View - ë¯¸ë¦¬ë³´ê¸°ìš©)
        // ìœ„ downloadPortableHTML ë‚´ë¶€ì˜ ë¡œì§ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€
        // ============================================================
        
        function splitCanvas(original) {
            const w=original.width, h=original.height, halfW=Math.floor(w/2);
            const l=document.createElement('canvas'), r=document.createElement('canvas');
            l.width=halfW; l.height=h; r.width=halfW; r.height=h;
            l.getContext('2d').drawImage(original,0,0,halfW,h,0,0,halfW,h);
            r.getContext('2d').drawImage(original,halfW,0,halfW,h,0,0,halfW,h);
            return [l,r];
        }

        async function loadPDF(data) {
            try {
                allPages = []; els.flipbook.innerHTML = ""; 
                const pdfDoc = await pdfjsLib.getDocument(data).promise;
                const fragment = document.createDocumentFragment();
                const firstPage = await pdfDoc.getPage(1);
                const firstViewport = firstPage.getViewport({ scale: 1.0 });
                pdfOriginalRatio = (firstViewport.width > firstViewport.height * 1.1) ? (firstViewport.width / 2) / firstViewport.height : firstViewport.width / firstViewport.height;

                for (let i = 1; i <= pdfDoc.numPages; i++) {
                    const page = await pdfDoc.getPage(i);
                    const viewport = page.getViewport({ scale: 2.0 }); // PCìš© ê³ í™”ì§ˆ
                    const canvas = document.createElement('canvas');
                    canvas.width = viewport.width; canvas.height = viewport.height;
                    await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;

                    if (viewport.width > viewport.height * 1.1) {
                        const [l, r] = splitCanvas(canvas);
                        l.classList.add('page-canvas'); r.classList.add('page-canvas');
                        l.dataset.pdfIdx = i; r.dataset.pdfIdx = i; 
                        allPages.push(l); allPages.push(r); fragment.appendChild(l); fragment.appendChild(r);
                    } else {
                        canvas.classList.add('page-canvas'); canvas.dataset.pdfIdx = i;
                        allPages.push(canvas); fragment.appendChild(canvas);
                    }
                    els.loading.innerText = `ë³€í™˜ ì¤‘... (${i}/${pdfDoc.numPages})`;
                }
                els.flipbook.appendChild(fragment);
                els.loading.style.display = 'none';
                initFlipBook();
            } catch (e) {
                console.error(e);
                alert("ì˜¤ë¥˜: " + e.message);
                location.reload();
            }
        }

        // ë°˜ì‘í˜• ì´ˆê¸°í™” (ë¯¸ë¦¬ë³´ê¸° í™”ë©´ìš©)
        function initFlipBook() {
            const isLandscape = window.innerWidth > window.innerHeight;
            const padding = isLandscape ? 60 : 30;
            const containerW = els.bookContainer.clientWidth - padding;
            const containerH = els.bookContainer.clientHeight - padding;

            let bookH = containerH;
            let bookW = 0;

            if (isLandscape) {
                // PC/íƒœë¸”ë¦¿ ê°€ë¡œ: Spread ëª¨ë“œ (ë‘ í˜ì´ì§€ ë„ˆë¹„)
                bookW = (bookH * pdfOriginalRatio) * 2;
                if (bookW > containerW) {
                    bookW = containerW;
                    bookH = (bookW / 2) / pdfOriginalRatio;
                }
            } else {
                // ëª¨ë°”ì¼ ì„¸ë¡œ: Portrait ëª¨ë“œ (í•œ í˜ì´ì§€ ë„ˆë¹„)
                bookW = bookH * pdfOriginalRatio;
                if (bookW > containerW) {
                    bookW = containerW;
                    bookH = bookW / pdfOriginalRatio;
                }
            }

            bookW = Math.floor(bookW); bookH = Math.floor(bookH);

            pageFlip = new St.PageFlip(els.flipbook, { 
                width: bookW, 
                height: bookH, 
                size: "fixed", 
                usePortrait: !isLandscape, // ê°€ë¡œë©´ false(ë‘ìª½), ì„¸ë¡œë©´ true(í•œìª½)
                maxShadowOpacity: 0.5, 
                autoSize: true,
                showCover: true
            });

            pageFlip.loadFromHTML(allPages);
            totalPages = pageFlip.getPageCount();
            els.slider.max = totalPages - 1;
            
            pageFlip.on('flip', (e) => { 
                els.pageInfo.innerText = `${e.data + 1} / ${totalPages}`; 
                els.slider.value = e.data; 
            });
            
            els.slider.addEventListener('input', (e) => pageFlip.flip(parseInt(e.target.value)));
            els.bookContainer.addEventListener('touchend', handleTouch);
            els.bookContainer.addEventListener('click', handleTouch);
        }
        
        // í‚¤ë³´ë“œ ì´ë²¤íŠ¸ (ë¯¸ë¦¬ë³´ê¸° í™”ë©´ìš©)
        document.addEventListener('keydown', (e) => {
            if (!pageFlip) return;
            if (e.key === "ArrowRight") pageFlip.flipNext();
            if (e.key === "ArrowLeft") pageFlip.flipPrev();
        });

        function handleTouch(e) {
            if (e.target.closest('#ui-controls') || e.target.closest('#top-buttons')) return;
            const currentTime = new Date().getTime();
            if (currentTime - lastTap < 300 && currentTime - lastTap > 0) { openZoomView(); e.preventDefault(); } 
            else { setTimeout(() => { if (new Date().getTime() - lastTap > 350) els.ui.classList.toggle('hidden'); }, 350); }
            lastTap = currentTime;
        }

        function openZoomView() {
            const currentIdx = pageFlip.getCurrentPageIndex();
            const currentPage = allPages[currentIdx];
            if (currentPage) {
                els.zoomImg.src = currentPage.toDataURL();
                els.zoomLayer.style.display = 'block';
                if (zoomInstance) zoomInstance.dispose();
                zoomInstance = Panzoom(document.getElementById('zoom-container'), { maxScale: 5, minScale: 1, contain: 'outside' });
                document.getElementById('zoom-container').addEventListener('wheel', zoomInstance.zoomWithWheel);
            }
        }
        els.zoomClose.addEventListener('click', () => { els.zoomLayer.style.display = 'none'; if(zoomInstance) zoomInstance.dispose(); });
        
        els.btnFullscreen.addEventListener('click', () => {
            if (!document.fullscreenElement) { 
                document.documentElement.requestFullscreen().catch(err => console.log(err));
                els.btnFullscreen.innerText = "ì¶•ì†Œ"; 
            } else { 
                if(document.exitFullscreen) document.exitFullscreen(); 
                els.btnFullscreen.innerText = "ì „ì²´í™”ë©´"; 
            }
        });

        document.addEventListener('fullscreenchange', () => {
            setTimeout(() => { 
                if(pageFlip){ 
                    const idx = pageFlip.getCurrentPageIndex(); 
                    pageFlip.destroy(); 
                    els.flipbook.innerHTML=""; 
                    allPages.forEach(p=>els.flipbook.appendChild(p)); 
                    initFlipBook(); 
                    if(idx < pageFlip.getPageCount()) pageFlip.turnToPage(idx); 
                }
            }, 200);
            if (document.fullscreenElement) els.btnFullscreen.innerText = "ì¶•ì†Œ"; 
            else els.btnFullscreen.innerText = "ì „ì²´í™”ë©´";
        });
        
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => { 
                if(pageFlip && allPages.length > 0) { 
                    const idx = pageFlip.getCurrentPageIndex(); 
                    pageFlip.destroy(); 
                    els.flipbook.innerHTML=""; 
                    allPages.forEach(p=>els.flipbook.appendChild(p)); 
                    initFlipBook(); 
                    if(idx < pageFlip.getPageCount()) pageFlip.turnToPage(idx); 
                }
            }, 300);
        });

    </script>
</body>
</html>
