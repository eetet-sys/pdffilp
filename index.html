<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Smart E-Book</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e1e20">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.min.js"></script>
    <script src="https://unpkg.com/@panzoom/panzoom@4.5.1/dist/panzoom.min.js"></script>
    
    <style>
        :root { --bg-color: #1e1e20; --ui-bg: rgba(30, 30, 30, 0.95); --accent: #64c8ff; --text: #ffffff; }
        
        /* [중요] 100dvh로 모바일 주소창 높이 문제 해결 */
        body { margin: 0; padding: 0; background-color: var(--bg-color); color: var(--text); font-family: 'Pretendard', 'Malgun Gothic', sans-serif; overflow: hidden; height: 100vh; height: 100dvh; width: 100vw; display: flex; flex-direction: column; }
        
        #book-container { flex: 1; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; z-index: 1; background-color: var(--bg-color); }
        
        .stf__wrapper { box-shadow: 0 5px 20px rgba(0,0,0,0.5); }
        
        /* UI 컨트롤 바 디자인 개선 */
        #ui-controls { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--ui-bg); padding: 15px 20px calc(15px + env(safe-area-inset-bottom)) 20px; display: flex; flex-direction: column; gap: 10px; z-index: 10; transition: transform 0.3s ease; box-sizing: border-box; border-top: 1px solid #444; backdrop-filter: blur(10px); }
        #ui-controls.hidden { transform: translateY(100%); }
        
        .control-row { display: flex; justify-content: space-between; align-items: center; width: 100%; max-width: 600px; margin: 0 auto; }
        
        #page-slider { width: 100%; height: 6px; -webkit-appearance: none; background: rgba(255,255,255,0.2); border-radius: 3px; outline: none; }
        #page-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; background: var(--accent); border-radius: 50%; cursor: pointer; }
        
        #page-info { font-size: 14px; color: #ddd; font-variant-numeric: tabular-nums; min-width: 60px; text-align: center;}
        
        .btn-icon { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; border-radius: 6px; padding: 8px 12px; font-size: 13px; cursor: pointer; white-space: nowrap; }

        /* 시작 화면 */
        #start-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .btn-upload { background-color: var(--accent); color: #000; border: none; padding: 15px 40px; font-size: 16px; font-weight: bold; border-radius: 30px; box-shadow: 0 0 20px rgba(100, 200, 255, 0.3); margin-bottom: 20px; cursor: pointer; }
        #loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none; z-index: 90; font-size: 16px; color: white; background: rgba(0,0,0,0.8); padding: 20px; border-radius: 10px; }

        /* 줌 레이어 */
        #zoom-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.98); z-index: 999; display: none; overflow: hidden; }
        #zoom-container { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
        #zoom-img { max-width: 100%; max-height: 100%; object-fit: contain; }
        #zoom-close-btn { position: absolute; top: 20px; right: 20px; background: rgba(50,50,50,0.8); color: white; border: 1px solid #777; width: 40px; height: 40px; border-radius: 50%; font-size: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 1000; }
        
        .top-btn-group { position: absolute; top: 10px; right: 10px; z-index: 50; display: none; gap: 8px; }
        .top-btn { border: none; color: white; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        #btn-export { background: #6f42c1; } 
        #btn-reset { background: #ff4444; } 
    </style>
</head>
<body>

    <div class="top-btn-group" id="top-buttons">
        <button id="btn-export" class="top-btn">공유용 파일 저장</button>
        <button id="btn-reset" class="top-btn">초기화</button>
    </div>

    <div id="start-screen">
        <h2 style="color:var(--accent); margin-bottom: 10px;">Smart Library</h2>
        <p style="color:#aaa; margin-bottom: 30px; font-size: 14px;">모바일/PC 완벽 호환 뷰어</p>
        <input type="file" id="file-input" accept="application/pdf" style="display: none;">
        <button class="btn-upload" onclick="document.getElementById('file-input').click()">PDF 파일 열기</button>
    </div>

    <div id="loading">로딩 중...</div>

    <div id="book-container">
        <div id="flipbook"></div>
    </div>

    <div id="ui-controls">
        <div class="control-row" style="margin-bottom: 10px;">
            <span id="page-info">0 / 0</span>
            <button class="btn-icon" id="btn-fullscreen">전체화면</button>
        </div>
        <div class="control-row">
            <input type="range" id="page-slider" min="0" max="100" value="0">
        </div>
    </div>

    <div id="zoom-layer">
        <div id="zoom-close-btn">✕</div>
        <div id="zoom-container"><img id="zoom-img" src="" alt="Zoom Image"></div>
    </div>

    <script>
        if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js').catch(()=>{});
        
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // === IndexedDB ===
        const DB_NAME="EbookDB", STORE_NAME="files";
        function openDB(){ return new Promise((res,rej)=>{ const r=indexedDB.open(DB_NAME,1); r.onupgradeneeded=(e)=>e.target.result.createObjectStore(STORE_NAME); r.onsuccess=(e)=>res(e.target.result); r.onerror=(e)=>rej(e); }); }
        async function saveFileToDB(d){ const db=await openDB(); const tx=db.transaction(STORE_NAME,"readwrite"); tx.objectStore(STORE_NAME).put(d,"currentBook"); return new Promise(r=>tx.oncomplete=r); }
        async function loadFileFromDB(){ const db=await openDB(); const tx=db.transaction(STORE_NAME,"readonly"); const r=tx.objectStore(STORE_NAME).get("currentBook"); return new Promise(res=>{r.onsuccess=()=>res(r.result)}); }
        async function clearDB(){ const db=await openDB(); const tx=db.transaction(STORE_NAME,"readwrite"); tx.objectStore(STORE_NAME).delete("currentBook"); return new Promise(r=>tx.oncomplete=r); }

        const els = {
            fileInput: document.getElementById('file-input'), startScreen: document.getElementById('start-screen'),
            loading: document.getElementById('loading'), bookContainer: document.getElementById('book-container'),
            flipbook: document.getElementById('flipbook'), ui: document.getElementById('ui-controls'),
            slider: document.getElementById('page-slider'), pageInfo: document.getElementById('page-info'),
            btnFullscreen: document.getElementById('btn-fullscreen'), zoomLayer: document.getElementById('zoom-layer'),
            zoomImg: document.getElementById('zoom-img'), zoomClose: document.getElementById('zoom-close-btn'),
            topButtons: document.getElementById('top-buttons'), btnReset: document.getElementById('btn-reset'), btnExport: document.getElementById('btn-export')
        };

        let allPages=[], pageFlip, totalPages=0, currentPDFData=null, zoomInstance=null, lastTap=0, pdfOriginalRatio=0.7;

        window.addEventListener('DOMContentLoaded', async () => {
            const saved = await loadFileFromDB();
            if (saved) {
                currentPDFData = saved; 
                startViewer(saved.slice(0)); // [중요] 복사본 전달
            }
        });

        els.fileInput.addEventListener('change', async (e) => {
            const f = e.target.files[0]; if(!f) return;
            const d = await f.arrayBuffer();
            currentPDFData = d; 
            await saveFileToDB(d);
            startViewer(d.slice(0)); // [중요] 복사본 전달
        });

        function startViewer(data) {
            els.startScreen.style.display='none'; els.loading.style.display='block'; els.topButtons.style.display='flex';
            loadPDF(data);
        }

        els.btnReset.addEventListener('click', async()=>{ if(confirm("초기화하시겠습니까?")){ await clearDB(); location.reload(); } });

        els.btnExport.addEventListener('click', () => {
            if (!currentPDFData || currentPDFData.byteLength === 0) return alert("데이터 오류: 파일을 다시 열어주세요.");
            els.loading.style.display='block'; els.loading.innerText="공유 파일 생성 중...";
            setTimeout(async () => {
                try {
                    // [중요] 내보낼 때도 복사본 사용
                    const base64 = await arrayBufferToBase64(currentPDFData.slice(0));
                    downloadPortableHTML(base64);
                } catch(e) { alert("생성 실패: "+e.message); }
                els.loading.style.display='none';
            }, 100);
        });

        function arrayBufferToBase64(buffer) {
            return new Promise((resolve, reject) => {
                const blob = new Blob([buffer], { type: 'application/pdf' });
                const reader = new FileReader();
                reader.onloadend = () => reader.result ? resolve(reader.result.split(',')[1]) : reject(new Error("변환 실패"));
                reader.readAsDataURL(blob);
            });
        }

        async function loadPDF(data) {
            try {
                if(pageFlip) pageFlip.destroy(); // 기존 뷰어 완전 파괴
                allPages = []; els.flipbook.innerHTML = "";
                
                const pdfDoc = await pdfjsLib.getDocument(data).promise;
                const fragment = document.createDocumentFragment();
                const firstPage = await pdfDoc.getPage(1);
                const firstViewport = firstPage.getViewport({ scale: 1.0 });
                
                pdfOriginalRatio = (firstViewport.width > firstViewport.height * 1.1) 
                    ? (firstViewport.width / 2) / firstViewport.height 
                    : firstViewport.width / firstViewport.height;

                for (let i = 1; i <= pdfDoc.numPages; i++) {
                    const page = await pdfDoc.getPage(i);
                    // 화질 2.0으로 상향 (PC/모바일 공통)
                    const viewport = page.getViewport({ scale: 2.0 });
                    const canvas = document.createElement('canvas');
                    canvas.width = viewport.width; canvas.height = viewport.height;
                    await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;

                    if (viewport.width > viewport.height * 1.1) {
                        const [l, r] = splitCanvas(canvas);
                        l.classList.add('page-canvas'); r.classList.add('page-canvas');
                        l.dataset.pdfIdx = i; r.dataset.pdfIdx = i;
                        allPages.push(l); allPages.push(r); fragment.appendChild(l); fragment.appendChild(r);
                    } else {
                        canvas.classList.add('page-canvas'); canvas.dataset.pdfIdx = i;
                        allPages.push(canvas); fragment.appendChild(canvas);
                    }
                    els.loading.innerText = `변환 중... (${i}/${pdfDoc.numPages})`;
                }
                els.flipbook.appendChild(fragment);
                els.loading.style.display = 'none';
                initFlipBook();
            } catch (e) {
                console.error(e);
                alert("오류: " + e.message);
                if(confirm("저장된 데이터를 초기화할까요?")) { await clearDB(); location.reload(); }
            }
        }

        function splitCanvas(original) {
            const w=original.width, h=original.height, halfW=Math.floor(w/2);
            const l=document.createElement('canvas'), r=document.createElement('canvas');
            l.width=halfW; l.height=h; r.width=halfW; r.height=h;
            l.getContext('2d').drawImage(original,0,0,halfW,h,0,0,halfW,h);
            r.getContext('2d').drawImage(original,halfW,0,halfW,h,0,0,halfW,h);
            return [l,r];
        }

        function initFlipBook() {
            const isLandscape = window.innerWidth > window.innerHeight;
            // [중요] 여백 계산 수정 (모바일 오버랩 방지)
            const paddingX = isLandscape ? 40 : 0;
            const paddingY = isLandscape ? 40 : 10;
            
            const containerW = els.bookContainer.clientWidth - paddingX;
            const containerH = els.bookContainer.clientHeight - paddingY;

            let bookH = containerH;
            let bookW = 0;

            if (isLandscape) {
                bookW = (bookH * pdfOriginalRatio) * 2;
                if (bookW > containerW) { bookW = containerW; bookH = (bookW / 2) / pdfOriginalRatio; }
            } else {
                bookW = containerW; 
                bookH = bookW / pdfOriginalRatio;
                if (bookH > containerH) { bookH = containerH; bookW = bookH * pdfOriginalRatio; }
            }

            bookW = Math.floor(bookW); bookH = Math.floor(bookH);

            pageFlip = new St.PageFlip(els.flipbook, {
                width: bookW, height: bookH, size: 'fixed',
                usePortrait: !isLandscape, maxShadowOpacity: 0.5, autoSize: true, showCover: true
            });

            pageFlip.loadFromHTML(allPages);
            totalPages = pageFlip.getPageCount();
            els.slider.max = totalPages - 1;

            pageFlip.on('flip', (e)=>{ els.pageInfo.innerText = (e.data+1)+' / '+totalPages; els.slider.value=e.data; });
            els.slider.addEventListener('input', (e)=>pageFlip.flip(parseInt(e.target.value)));
            els.bookContainer.addEventListener('touchend', handleTouch);
            els.bookContainer.addEventListener('click', handleTouch);
        }

        function handleTouch(e) {
            if (e.target.closest('#ui-controls') || e.target.closest('#top-buttons')) return;
            const currentTime = new Date().getTime();
            if (currentTime - lastTap < 300 && currentTime - lastTap > 0) { openZoomView(); e.preventDefault(); } 
            else { setTimeout(() => { if (new Date().getTime() - lastTap > 350) els.ui.classList.toggle('hidden'); }, 350); }
            lastTap = currentTime;
        }

        function openZoomView() {
            const currentIdx = pageFlip.getCurrentPageIndex();
            const currentPage = allPages[currentIdx];
            if (currentPage) {
                els.zoomImg.src = currentPage.toDataURL();
                els.zoomLayer.style.display = 'block';
                if (zoomInstance) zoomInstance.dispose();
                zoomInstance = Panzoom(document.getElementById('zoom-container'), { maxScale: 4, minScale: 1, contain: 'outside' });
                document.getElementById('zoom-container').addEventListener('wheel', zoomInstance.zoomWithWheel);
            }
        }
        els.zoomClose.addEventListener('click', () => { els.zoomLayer.style.display = 'none'; });
        
        els.btnFullscreen.addEventListener('click', () => {
            if (!document.fullscreenElement) { document.documentElement.requestFullscreen(); els.btnFullscreen.innerText = "축소"; }
            else { if(document.exitFullscreen) document.exitFullscreen(); els.btnFullscreen.innerText = "전체화면"; }
        });

        // [중요] 리사이즈/회전 시 재렌더링 안정성 확보
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => { 
                if(pageFlip && allPages.length > 0) { 
                    const idx = pageFlip.getCurrentPageIndex(); 
                    pageFlip.destroy(); // 뷰어 파괴
                    els.flipbook.innerHTML=""; // DOM 청소
                    allPages.forEach(p=>els.flipbook.appendChild(p)); // 캔버스 재부착
                    initFlipBook(); // 뷰어 재시작
                    if(idx < pageFlip.getPageCount()) pageFlip.turnToPage(idx); 
                }
            }, 300);
        });

        // --------------------------------------------------------
        // [내보내기용 HTML 생성 함수] - 템플릿 내부 코드도 수정됨
        // --------------------------------------------------------
        function downloadPortableHTML(base64Data) {
            const htmlContent = `<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>My E-Book</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"><\/script>
<script src="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.min.js"><\/script>
<script src="https://unpkg.com/@panzoom/panzoom@4.5.1/dist/panzoom.min.js"><\/script>
<style>
${document.querySelector('style').innerHTML}
#start-screen, .top-btn-group { display: none !important; }
</style>
</head>
<body>
<div id="loading">책을 펼치는 중...</div>
<div id="book-container"><div id="flipbook"></div></div>
<div id="ui-controls">
<div class="control-row" style="margin-bottom:10px;"><span id="page-info">0 / 0</span><button class="btn-icon" id="btn-fullscreen">전체화면</button></div>
<div class="control-row"><input type="range" id="page-slider" min="0" max="100" value="0"></div>
</div>
<div id="zoom-layer"><div id="zoom-close-btn">✕</div><div id="zoom-container"><img id="zoom-img" src=""></div></div>
<script>
const embeddedPDF = "${base64Data}";
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
window.addEventListener('DOMContentLoaded', ()=>{ 
 if(!embeddedPDF) return alert("데이터 없음");
 const bin=window.atob(embeddedPDF); const len=bin.length; const bytes=new Uint8Array(len);
 for(let i=0;i<len;i++) bytes[i]=bin.charCodeAt(i);
 loadPDF(bytes.buffer);
});
// 뷰어 로직 (동기화됨)
const els={loading:document.getElementById('loading'),bookContainer:document.getElementById('book-container'),flipbook:document.getElementById('flipbook'),ui:document.getElementById('ui-controls'),slider:document.getElementById('page-slider'),pageInfo:document.getElementById('page-info'),btnFullscreen:document.getElementById('btn-fullscreen'),zoomLayer:document.getElementById('zoom-layer'),zoomImg:document.getElementById('zoom-img'),zoomClose:document.getElementById('zoom-close-btn')};
let allPages=[],pageFlip,totalPages=0,lastTap=0,zoomInstance=null,pdfOriginalRatio=0.7;
function splitCanvas(o){const w=o.width,h=o.height,hw=Math.floor(w/2);const l=document.createElement('canvas'),r=document.createElement('canvas');l.width=hw;l.height=h;r.width=hw;r.height=h;l.getContext('2d').drawImage(o,0,0,hw,h,0,0,hw,h);r.getContext('2d').drawImage(o,hw,0,hw,h,0,0,hw,h);return[l,r];}
async function loadPDF(d){try{const pdf=await pdfjsLib.getDocument(d).promise;const frag=document.createDocumentFragment();const p1=await pdf.getPage(1);const v1=p1.getViewport({scale:1.0});pdfOriginalRatio=(v1.width>v1.height*1.1)?(v1.width/2)/v1.height:v1.width/v1.height;for(let i=1;i<=pdf.numPages;i++){const p=await pdf.getPage(i);const v=p.getViewport({scale:2.0});const c=document.createElement('canvas');c.width=v.width;c.height=v.height;await p.render({canvasContext:c.getContext('2d'),viewport:v}).promise;if(v.width>v.height*1.1){const[l,r]=splitCanvas(c);l.classList.add('page-canvas');r.classList.add('page-canvas');l.dataset.pdfIdx=i;r.dataset.pdfIdx=i;allPages.push(l);allPages.push(r);frag.appendChild(l);frag.appendChild(r);}else{c.classList.add('page-canvas');c.dataset.pdfIdx=i;allPages.push(c);frag.appendChild(c);}els.loading.innerText='변환 중... ('+i+'/'+pdf.numPages+')';}els.flipbook.appendChild(frag);els.loading.style.display='none';initFlipBook();}catch(e){alert('Err: '+e.message);}}
function initFlipBook(){
 const isLand=window.innerWidth>window.innerHeight; const pX=isLand?40:0, pY=isLand?40:10;
 const cW=els.bookContainer.clientWidth-pX, cH=els.bookContainer.clientHeight-pY;
 let bH=cH, bW=0;
 if(isLand){ bW=(bH*pdfOriginalRatio)*2; if(bW>cW){ bW=cW; bH=(bW/2)/pdfOriginalRatio; } }
 else{ bW=cW; bH=bW/pdfOriginalRatio; if(bH>cH){ bH=cH; bW=bH*pdfOriginalRatio; } }
 bW=Math.floor(bW); bH=Math.floor(bH);
 pageFlip=new St.PageFlip(els.flipbook,{width:bW,height:bH,size:'fixed',usePortrait:!isLand,maxShadowOpacity:0.5,autoSize:true,showCover:true});
 pageFlip.loadFromHTML(allPages); totalPages=pageFlip.getPageCount(); els.slider.max=totalPages-1;
 pageFlip.on('flip',(e)=>{els.pageInfo.innerText=(e.data+1)+' / '+totalPages;els.slider.value=e.data;});
 els.slider.addEventListener('input',(e)=>pageFlip.flip(parseInt(e.target.value)));
 els.bookContainer.addEventListener('touchend',HT); els.bookContainer.addEventListener('click',HT);
}
function HT(e){if(e.target.closest('#ui-controls'))return;const t=new Date().getTime();if(t-lastTap<300&&t-lastTap>0){OZ();e.preventDefault();}else{setTimeout(()=>{if(new Date().getTime()-lastTap>350)els.ui.classList.toggle('hidden');},350);}lastTap=t;}
function OZ(){const i=pageFlip.getCurrentPageIndex();const p=allPages[i];if(p){els.zoomImg.src=p.toDataURL();els.zoomLayer.style.display='block';if(zoomInstance)zoomInstance.dispose();zoomInstance=Panzoom(document.getElementById('zoom-container'),{maxScale:4,minScale:1,contain:'outside'});document.getElementById('zoom-container').addEventListener('wheel',zoomInstance.zoomWithWheel);}}
els.zoomClose.addEventListener('click',()=>{els.zoomLayer.style.display='none';});
els.btnFullscreen.addEventListener('click',()=>{if(!document.fullscreenElement){document.documentElement.requestFullscreen();els.btnFullscreen.innerText="축소";}else{if(document.exitFullscreen)document.exitFullscreen();els.btnFullscreen.innerText="전체화면";}});
let rt;window.addEventListener('resize',()=>{clearTimeout(rt);rt=setTimeout(()=>{if(pageFlip){const idx=pageFlip.getCurrentPageIndex();pageFlip.destroy();els.flipbook.innerHTML='';allPages.forEach(p=>els.flipbook.appendChild(p));initFlipBook();if(idx<pageFlip.getPageCount())pageFlip.turnToPage(idx);}},300);});
<\/script></body></html>`;
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'My_E-Book.html';
            document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
