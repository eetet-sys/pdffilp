<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Smart E-Book</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e1e20">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.min.js"></script>
    <script src="https://unpkg.com/@panzoom/panzoom@4.5.1/dist/panzoom.min.js"></script>
    
    <style>
        :root { --bg-color: #1e1e20; --ui-bg: rgba(30, 30, 30, 0.95); --accent: #64c8ff; --text: #ffffff; }
        
        body { margin: 0; padding: 0; background-color: var(--bg-color); color: var(--text); font-family: 'Pretendard', 'Malgun Gothic', sans-serif; overflow: hidden; height: 100vh; height: 100dvh; width: 100vw; display: flex; flex-direction: column; }
        
        #book-container { flex: 1; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; z-index: 1; background-color: var(--bg-color); }
        
        /* [ì¤‘ìš”] ìº”ë²„ìŠ¤ê°€ ì°Œê·¸ëŸ¬ì§€ì§€ ì•Šë„ë¡ CSS ê°•ì œ ì ìš© */
        .stf__block canvas {
            width: 100% !important;
            height: 100% !important;
            object-fit: contain !important;
        }

        .stf__wrapper { box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        
        #ui-controls { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--ui-bg); padding: 15px 20px calc(15px + env(safe-area-inset-bottom)) 20px; display: flex; flex-direction: column; gap: 10px; z-index: 10; transition: transform 0.3s ease; box-sizing: border-box; border-top: 1px solid #444; backdrop-filter: blur(10px); }
        #ui-controls.hidden { transform: translateY(100%); }
        
        .control-row { display: flex; justify-content: space-between; align-items: center; width: 100%; max-width: 600px; margin: 0 auto; }
        
        #page-slider { width: 100%; height: 6px; -webkit-appearance: none; background: rgba(255,255,255,0.2); border-radius: 3px; outline: none; }
        #page-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; background: var(--accent); border-radius: 50%; cursor: pointer; }
        
        #page-info { font-size: 14px; color: #ddd; font-variant-numeric: tabular-nums; min-width: 60px; text-align: center;}
        
        .btn-icon { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; border-radius: 6px; padding: 8px 12px; font-size: 13px; cursor: pointer; white-space: nowrap; }

        #start-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .btn-upload { background-color: var(--accent); color: #000; border: none; padding: 15px 40px; font-size: 16px; font-weight: bold; border-radius: 30px; box-shadow: 0 0 20px rgba(100, 200, 255, 0.3); margin-bottom: 20px; cursor: pointer; }
        #loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none; z-index: 90; font-size: 16px; color: white; background: rgba(0,0,0,0.8); padding: 20px; border-radius: 10px; }

        #zoom-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.98); z-index: 999; display: none; overflow: hidden; }
        #zoom-container { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
        #zoom-img { max-width: 100%; max-height: 100%; object-fit: contain; }
        #zoom-close-btn { position: absolute; top: 20px; right: 20px; background: rgba(50,50,50,0.8); color: white; border: 1px solid #777; width: 40px; height: 40px; border-radius: 50%; font-size: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 1000; }
        
        /* ë²„íŠ¼ ê·¸ë£¹ */
        .top-btn-group { position: absolute; top: 10px; right: 10px; z-index: 50; display: none; gap: 8px; flex-wrap: wrap; justify-content: flex-end;}
        .top-btn { border: none; color: white; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        #btn-export { background: #6f42c1; } 
        #btn-reset { background: #ff4444; }
        /* ê³µìœ  íŒŒì¼ì—ì„œë§Œ ë³´ì´ëŠ” ë²„íŠ¼ */
        #btn-view-mode { background: #28a745; } 
    </style>
</head>
<body>

    <div class="top-btn-group" id="top-buttons">
        <button id="btn-export" class="top-btn">ê³µìœ  íŒŒì¼ ì €ì¥</button>
        <button id="btn-reset" class="top-btn">ì´ˆê¸°í™”</button>
    </div>

    <div id="start-screen">
        <h2 style="color:var(--accent); margin-bottom: 10px;">Smart Library</h2>
        <p style="color:#aaa; margin-bottom: 30px; font-size: 14px;">ëª¨ë°”ì¼/PC ì™„ë²½ í˜¸í™˜ ë·°ì–´</p>
        <input type="file" id="file-input" accept="application/pdf" style="display: none;">
        <button class="btn-upload" onclick="document.getElementById('file-input').click()">PDF íŒŒì¼ ì—´ê¸°</button>
    </div>

    <div id="loading">ë¡œë”© ì¤‘...</div>

    <div id="book-container">
        <div id="flipbook"></div>
    </div>

    <div id="ui-controls">
        <div class="control-row" style="margin-bottom: 10px;">
            <span id="page-info">0 / 0</span>
            <button class="btn-icon" id="btn-fullscreen">ì „ì²´í™”ë©´</button>
        </div>
        <div class="control-row">
            <input type="range" id="page-slider" min="0" max="100" value="0">
        </div>
    </div>

    <div id="zoom-layer">
        <div id="zoom-close-btn">âœ•</div>
        <div id="zoom-container"><img id="zoom-img" src="" alt="Zoom Image"></div>
    </div>

    <script>
        if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js').catch(()=>{});
        
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // === DB Logic ===
        const DB_NAME="EbookDB", STORE_NAME="files";
        function openDB(){ return new Promise((res,rej)=>{ const r=indexedDB.open(DB_NAME,1); r.onupgradeneeded=(e)=>e.target.result.createObjectStore(STORE_NAME); r.onsuccess=(e)=>res(e.target.result); r.onerror=(e)=>rej(e); }); }
        async function saveFileToDB(d){ const db=await openDB(); const tx=db.transaction(STORE_NAME,"readwrite"); tx.objectStore(STORE_NAME).put(d,"currentBook"); return new Promise(r=>tx.oncomplete=r); }
        async function loadFileFromDB(){ const db=await openDB(); const tx=db.transaction(STORE_NAME,"readonly"); const r=tx.objectStore(STORE_NAME).get("currentBook"); return new Promise(res=>{r.onsuccess=()=>res(r.result)}); }
        async function clearDB(){ const db=await openDB(); const tx=db.transaction(STORE_NAME,"readwrite"); tx.objectStore(STORE_NAME).delete("currentBook"); return new Promise(r=>tx.oncomplete=r); }

        const els = {
            fileInput: document.getElementById('file-input'), startScreen: document.getElementById('start-screen'),
            loading: document.getElementById('loading'), bookContainer: document.getElementById('book-container'),
            flipbook: document.getElementById('flipbook'), ui: document.getElementById('ui-controls'),
            slider: document.getElementById('page-slider'), pageInfo: document.getElementById('page-info'),
            btnFullscreen: document.getElementById('btn-fullscreen'), zoomLayer: document.getElementById('zoom-layer'),
            zoomImg: document.getElementById('zoom-img'), zoomClose: document.getElementById('zoom-close-btn'),
            topButtons: document.getElementById('top-buttons'), btnReset: document.getElementById('btn-reset'), 
            btnExport: document.getElementById('btn-export')
        };

        let allPages=[], pageFlip, totalPages=0, currentPDFData=null, zoomInstance=null, lastTap=0, pdfOriginalRatio=0.7;
        let viewMode = 'auto'; 

        window.addEventListener('DOMContentLoaded', async () => {
            const saved = await loadFileFromDB();
            if (saved) { currentPDFData = saved; startViewer(saved.slice(0)); }
        });

        els.fileInput.addEventListener('change', async (e) => {
            const f = e.target.files[0]; if(!f) return;
            const d = await f.arrayBuffer(); currentPDFData = d; await saveFileToDB(d); startViewer(d.slice(0));
        });

        function startViewer(data) {
            els.startScreen.style.display='none'; els.loading.style.display='block'; els.topButtons.style.display='flex';
            loadPDF(data);
        }

        els.btnReset.addEventListener('click', async()=>{ if(confirm("ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")){ await clearDB(); location.reload(); } });

        els.btnExport.addEventListener('click', () => {
            if (!currentPDFData || currentPDFData.byteLength === 0) return alert("ë°ì´í„° ì˜¤ë¥˜: íŒŒì¼ì„ ë‹¤ì‹œ ì—´ì–´ì£¼ì„¸ìš”.");
            els.loading.style.display='block'; els.loading.innerText="ê³µìœ  íŒŒì¼ ìƒì„± ì¤‘...";
            setTimeout(async () => {
                try {
                    const base64 = await arrayBufferToBase64(currentPDFData.slice(0));
                    downloadPortableHTML(base64);
                } catch(e) { alert("ìƒì„± ì‹¤íŒ¨: "+e.message); }
                els.loading.style.display='none';
            }, 100);
        });

        function arrayBufferToBase64(buffer) {
            return new Promise((resolve, reject) => {
                const blob = new Blob([buffer], { type: 'application/pdf' });
                const reader = new FileReader();
                reader.onloadend = () => reader.result ? resolve(reader.result.split(',')[1]) : reject(new Error("ë³€í™˜ ì‹¤íŒ¨"));
                reader.readAsDataURL(blob);
            });
        }

        async function loadPDF(data) {
            try {
                if(pageFlip) pageFlip.destroy(); allPages = []; els.flipbook.innerHTML = "";
                const pdfDoc = await pdfjsLib.getDocument(data).promise;
                const fragment = document.createDocumentFragment();
                const firstPage = await pdfDoc.getPage(1);
                const firstViewport = firstPage.getViewport({ scale: 1.0 });
                // ë‹¨ì¼ í˜ì´ì§€ ê¸°ì¤€ ë¹„ìœ¨ ê³„ì‚°
                pdfOriginalRatio = (firstViewport.width > firstViewport.height * 1.1) ? (firstViewport.width / 2) / firstViewport.height : firstViewport.width / firstViewport.height;

                for (let i = 1; i <= pdfDoc.numPages; i++) {
                    const page = await pdfDoc.getPage(i);
                    const viewport = page.getViewport({ scale: 2.0 });
                    const canvas = document.createElement('canvas');
                    canvas.width = viewport.width; canvas.height = viewport.height;
                    await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;

                    if (viewport.width > viewport.height * 1.1) {
                        const [l, r] = splitCanvas(canvas);
                        l.classList.add('page-canvas'); r.classList.add('page-canvas');
                        l.dataset.pdfIdx = i; r.dataset.pdfIdx = i;
                        allPages.push(l); allPages.push(r); fragment.appendChild(l); fragment.appendChild(r);
                    } else {
                        canvas.classList.add('page-canvas'); canvas.dataset.pdfIdx = i;
                        allPages.push(canvas); fragment.appendChild(canvas);
                    }
                    els.loading.innerText = `ë³€í™˜ ì¤‘... (${i}/${pdfDoc.numPages})`;
                }
                els.flipbook.appendChild(fragment);
                els.loading.style.display = 'none';
                initFlipBook();
            } catch (e) {
                console.error(e); alert("ì˜¤ë¥˜: " + e.message);
                if(confirm("ì €ì¥ëœ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”?")) { await clearDB(); location.reload(); }
            }
        }

        function splitCanvas(o) {
            const w=o.width, h=o.height, hw=Math.floor(w/2);
            const l=document.createElement('canvas'), r=document.createElement('canvas');
            l.width=hw; l.height=h; r.width=hw; r.height=h;
            l.getContext('2d').drawImage(o,0,0,hw,h,0,0,hw,h);
            r.getContext('2d').drawImage(o,hw,0,hw,h,0,0,hw,h);
            return [l,r];
        }

        // [í•µì‹¬] ë¹„ìœ¨ ê¹¨ì§ ë°©ì§€ ê³„ì‚° ë¡œì§
        function initFlipBook() {
            const isLandscape = window.innerWidth > window.innerHeight;
            
            let targetMode = isLandscape ? 'double' : 'single';
            if (viewMode === 'single') targetMode = 'single';
            if (viewMode === 'double') targetMode = 'double';

            const isDouble = (targetMode === 'double');
            
            // ì—¬ë°±
            const paddingX = isDouble ? 60 : 0;
            const paddingY = isDouble ? 60 : 10;
            
            const containerW = els.bookContainer.clientWidth - paddingX;
            const containerH = els.bookContainer.clientHeight - paddingY;

            let bookH = containerH;
            let bookW = 0;

            // [ë¹„ìœ¨ ê³„ì‚° í•µì‹¬]
            // ëª©í‘œ ë¹„ìœ¨(Target Ratio) = (1ìª½ ë¹„ìœ¨) * (ìª½ìˆ˜)
            // 2ìª½ ë³´ê¸°ë©´ 2ë°° ë„“ì–´ì ¸ì•¼ í•¨.
            const targetRatio = isDouble ? (pdfOriginalRatio * 2) : pdfOriginalRatio;

            // 1. ë†’ì´ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë„ˆë¹„ ê³„ì‚° (ê¸°ë³¸)
            bookW = bookH * targetRatio;

            // 2. ë§Œì•½ ê³„ì‚°ëœ ë„ˆë¹„ê°€ ì»¨í…Œì´ë„ˆë³´ë‹¤ í¬ë‹¤ë©´? -> ë„ˆë¹„ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë†’ì´ ì¬ì¡°ì •
            if (bookW > containerW) {
                bookW = containerW;
                bookH = bookW / targetRatio;
            }

            // ì†Œìˆ˜ì  ì œê±° (ë Œë”ë§ ì˜¤ì°¨ ë°©ì§€)
            bookW = Math.floor(bookW); 
            bookH = Math.floor(bookH);

            pageFlip = new St.PageFlip(els.flipbook, {
                width: bookW, 
                height: bookH, 
                size: 'fixed', // ê³ ì • í¬ê¸° ëª¨ë“œ ì‚¬ìš© (ë¹„ìœ¨ ìœ ì§€ í•„ìˆ˜)
                usePortrait: !isDouble,
                maxShadowOpacity: 0.5, 
                autoSize: true, // ìº”ë²„ìŠ¤ë¥¼ bookW, bookHì— ë§ì¶¤
                showCover: true
            });

            pageFlip.loadFromHTML(allPages);
            totalPages = pageFlip.getPageCount();
            els.slider.max = totalPages - 1;

            pageFlip.on('flip', (e)=>{ els.pageInfo.innerText = (e.data+1)+' / '+totalPages; els.slider.value=e.data; });
            els.slider.addEventListener('input', (e)=>pageFlip.flip(parseInt(e.target.value)));
            els.bookContainer.addEventListener('touchend', handleTouch);
            els.bookContainer.addEventListener('click', handleTouch);
        }

        function reloadFlipBook() {
            if(pageFlip && allPages.length > 0) {
                const idx = pageFlip.getCurrentPageIndex();
                pageFlip.destroy();
                els.flipbook.innerHTML="";
                allPages.forEach(p=>els.flipbook.appendChild(p));
                initFlipBook();
                if(idx < pageFlip.getPageCount()) pageFlip.turnToPage(idx);
            }
        }

        function handleTouch(e) {
            if (e.target.closest('#ui-controls') || e.target.closest('#top-buttons')) return;
            const currentTime = new Date().getTime();
            if (currentTime - lastTap < 300 && currentTime - lastTap > 0) { openZoomView(); e.preventDefault(); } 
            else { setTimeout(() => { if (new Date().getTime() - lastTap > 350) els.ui.classList.toggle('hidden'); }, 350); }
            lastTap = currentTime;
        }

        function openZoomView() {
            const currentIdx = pageFlip.getCurrentPageIndex();
            const currentPage = allPages[currentIdx];
            if (currentPage) {
                els.zoomImg.src = currentPage.toDataURL();
                els.zoomLayer.style.display = 'block';
                if (zoomInstance) zoomInstance.dispose();
                zoomInstance = Panzoom(document.getElementById('zoom-container'), { maxScale: 4, minScale: 1, contain: 'outside' });
                document.getElementById('zoom-container').addEventListener('wheel', zoomInstance.zoomWithWheel);
            }
        }
        els.zoomClose.addEventListener('click', () => { els.zoomLayer.style.display = 'none'; });
        
        els.btnFullscreen.addEventListener('click', () => {
            if (!document.fullscreenElement) { document.documentElement.requestFullscreen(); els.btnFullscreen.innerText = "ì¶•ì†Œ"; }
            else { if(document.exitFullscreen) document.exitFullscreen(); els.btnFullscreen.innerText = "ì „ì²´í™”ë©´"; }
        });

        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => { reloadFlipBook(); }, 300);
        });

        // --------------------------------------------------------
        // [ë‚´ë³´ë‚´ê¸°ìš© HTML ìƒì„± í•¨ìˆ˜] - ì—¬ê¸°ì—ë§Œ ë³´ê¸°ëª¨ë“œ ë²„íŠ¼ í¬í•¨
        // --------------------------------------------------------
        function downloadPortableHTML(base64Data) {
            const htmlContent = `<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>My E-Book</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"><\/script>
<script src="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.min.js"><\/script>
<script src="https://unpkg.com/@panzoom/panzoom@4.5.1/dist/panzoom.min.js"><\/script>
<style>
${document.querySelector('style').innerHTML}
#start-screen, #btn-export, #btn-reset { display: none !important; }
.top-btn-group { display: flex !important; }
</style>
</head>
<body>
<div class="top-btn-group" id="top-buttons"><button id="btn-view-mode" class="top-btn">ğŸ‘ï¸ ë³´ê¸°: ìë™</button></div>
<div id="loading">ì±…ì„ í¼ì¹˜ëŠ” ì¤‘...</div>
<div id="book-container"><div id="flipbook"></div></div>
<div id="ui-controls">
<div class="control-row" style="margin-bottom:10px;"><span id="page-info">0 / 0</span><button class="btn-icon" id="btn-fullscreen">ì „ì²´í™”ë©´</button></div>
<div class="control-row"><input type="range" id="page-slider" min="0" max="100" value="0"></div>
</div>
<div id="zoom-layer"><div id="zoom-close-btn">âœ•</div><div id="zoom-container"><img id="zoom-img" src=""></div></div>
<script>
const embeddedPDF = "${base64Data}";
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
window.addEventListener('DOMContentLoaded', ()=>{ 
 if(!embeddedPDF) return alert("ë°ì´í„° ì—†ìŒ");
 const bin=window.atob(embeddedPDF); const len=bin.length; const bytes=new Uint8Array(len);
 for(let i=0;i<len;i++) bytes[i]=bin.charCodeAt(i);
 loadPDF(bytes.buffer);
});
// ë·°ì–´ ë¡œì§ (ë™ì¼í•¨ + ë³´ê¸°ëª¨ë“œ ì¶”ê°€)
const els={loading:document.getElementById('loading'),bookContainer:document.getElementById('book-container'),flipbook:document.getElementById('flipbook'),ui:document.getElementById('ui-controls'),slider:document.getElementById('page-slider'),pageInfo:document.getElementById('page-info'),btnFullscreen:document.getElementById('btn-fullscreen'),zoomLayer:document.getElementById('zoom-layer'),zoomImg:document.getElementById('zoom-img'),zoomClose:document.getElementById('zoom-close-btn'),btnViewMode:document.getElementById('btn-view-mode')};
let allPages=[],pageFlip,totalPages=0,lastTap=0,zoomInstance=null,pdfOriginalRatio=0.7,viewMode='auto';
function splitCanvas(o){const w=o.width,h=o.height,hw=Math.floor(w/2);const l=document.createElement('canvas'),r=document.createElement('canvas');l.width=hw;l.height=h;r.width=hw;r.height=h;l.getContext('2d').drawImage(o,0,0,hw,h,0,0,hw,h);r.getContext('2d').drawImage(o,hw,0,hw,h,0,0,hw,h);return[l,r];}
async function loadPDF(d){try{const pdf=await pdfjsLib.getDocument(d).promise;const frag=document.createDocumentFragment();const p1=await pdf.getPage(1);const v1=p1.getViewport({scale:1.0});pdfOriginalRatio=(v1.width>v1.height*1.1)?(v1.width/2)/v1.height:v1.width/v1.height;for(let i=1;i<=pdf.numPages;i++){const p=await pdf.getPage(i);const v=p.getViewport({scale:2.0});const c=document.createElement('canvas');c.width=v.width;c.height=v.height;await p.render({canvasContext:c.getContext('2d'),viewport:v}).promise;if(v.width>v.height*1.1){const[l,r]=splitCanvas(c);l.classList.add('page-canvas');r.classList.add('page-canvas');l.dataset.pdfIdx=i;r.dataset.pdfIdx=i;allPages.push(l);allPages.push(r);frag.appendChild(l);frag.appendChild(r);}else{c.classList.add('page-canvas');c.dataset.pdfIdx=i;allPages.push(c);frag.appendChild(c);}els.loading.innerText='ë³€í™˜ ì¤‘... ('+i+'/'+pdf.numPages+')';}els.flipbook.appendChild(frag);els.loading.style.display='none';initFlipBook();}catch(e){alert('Err: '+e.message);}}
els.btnViewMode.addEventListener('click',()=>{if(viewMode==='auto'){viewMode='single';els.btnViewMode.innerText='ğŸ‘ï¸ ë³´ê¸°: 1ìª½';}else if(viewMode==='single'){viewMode='double';els.btnViewMode.innerText='ğŸ‘ï¸ ë³´ê¸°: 2ìª½';}else{viewMode='auto';els.btnViewMode.innerText='ğŸ‘ï¸ ë³´ê¸°: ìë™';}reloadFlipBook();});
function initFlipBook(){
 const isLand=window.innerWidth>window.innerHeight;
 let targetMode=isLand?'double':'single';
 if(viewMode==='single') targetMode='single'; if(viewMode==='double') targetMode='double';
 const isDouble=(targetMode==='double');
 const pX=isDouble?60:0, pY=isDouble?60:10;
 const cW=els.bookContainer.clientWidth-pX, cH=els.bookContainer.clientHeight-pY;
 let bH=cH, bW=0;
 const targetRatio = isDouble ? (pdfOriginalRatio * 2) : pdfOriginalRatio;
 bW = bH * targetRatio;
 if(bW > cW) { bW = cW; bH = bW / targetRatio; }
 bW=Math.floor(bW); bH=Math.floor(bH);
 pageFlip=new St.PageFlip(els.flipbook,{width:bW,height:bH,size:'fixed',usePortrait:!isDouble,maxShadowOpacity:0.5,autoSize:true,showCover:true});
 pageFlip.loadFromHTML(allPages); totalPages=pageFlip.getPageCount(); els.slider.max=totalPages-1;
 pageFlip.on('flip',(e)=>{els.pageInfo.innerText=(e.data+1)+' / '+totalPages;els.slider.value=e.data;});
 els.slider.addEventListener('input',(e)=>pageFlip.flip(parseInt(e.target.value)));
 els.bookContainer.addEventListener('touchend',HT); els.bookContainer.addEventListener('click',HT);
}
function reloadFlipBook(){if(pageFlip&&allPages.length>0){const idx=pageFlip.getCurrentPageIndex();pageFlip.destroy();els.flipbook.innerHTML="";allPages.forEach(p=>els.flipbook.appendChild(p));initFlipBook();if(idx<pageFlip.getPageCount())pageFlip.turnToPage(idx);}}
function HT(e){if(e.target.closest('#ui-controls')||e.target.closest('.top-btn-group'))return;const t=new Date().getTime();if(t-lastTap<300&&t-lastTap>0){OZ();e.preventDefault();}else{setTimeout(()=>{if(new Date().getTime()-lastTap>350)els.ui.classList.toggle('hidden');},350);}lastTap=t;}
function OZ(){const i=pageFlip.getCurrentPageIndex();const p=allPages[i];if(p){els.zoomImg.src=p.toDataURL();els.zoomLayer.style.display='block';if(zoomInstance)zoomInstance.dispose();zoomInstance=Panzoom(document.getElementById('zoom-container'),{maxScale:4,minScale:1,contain:'outside'});document.getElementById('zoom-container').addEventListener('wheel',zoomInstance.zoomWithWheel);}}
els.zoomClose.addEventListener('click',()=>{els.zoomLayer.style.display='none';});
els.btnFullscreen.addEventListener('click',()=>{if(!document.fullscreenElement){document.documentElement.requestFullscreen();els.btnFullscreen.innerText="ì¶•ì†Œ";}else{if(document.exitFullscreen)document.exitFullscreen();els.btnFullscreen.innerText="ì „ì²´í™”ë©´";}});
let rt;window.addEventListener('resize',()=>{clearTimeout(rt);rt=setTimeout(()=>{reloadFlipBook();},300);});
<\/script></body></html>`;
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'My_E-Book.html';
            document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
