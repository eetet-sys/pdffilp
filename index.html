<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Smart E-Book</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#121214">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.min.js"></script>
    <script src="https://unpkg.com/@panzoom/panzoom@4.5.1/dist/panzoom.min.js"></script>
    
    <style>
        :root { --bg-color: #121214; --ui-bg: rgba(20, 20, 20, 0.85); --accent: #64c8ff; --text: #ffffff; }
        body { margin: 0; padding: 0; background-color: var(--bg-color); color: var(--text); font-family: 'Malgun Gothic', sans-serif; overflow: hidden; height: 100vh; width: 100vw; display: flex; flex-direction: column; }
        #book-container { flex: 1; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; z-index: 1; }
        #book-container:fullscreen { background-color: var(--bg-color); width: 100vw; height: 100vh; } 
        .stf__wrapper { box-shadow: 0 0 30px rgba(0,0,0,0.6); }
        
        #ui-controls { position: fixed; bottom: 0; left: 0; width: 100%; background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); padding: 20px 10px 30px 10px; display: flex; flex-direction: column; gap: 10px; z-index: 10; transition: transform 0.3s ease; box-sizing: border-box; }
        #ui-controls.hidden { transform: translateY(100%); }
        .control-row { display: flex; justify-content: space-between; align-items: center; width: 100%; padding: 0 10px; box-sizing: border-box; }
        #page-slider { width: 100%; height: 6px; -webkit-appearance: none; background: rgba(255,255,255,0.3); border-radius: 3px; outline: none; }
        #page-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; background: var(--accent); border-radius: 50%; cursor: pointer; box-shadow: 0 0 10px rgba(100,200,255,0.5); }
        #page-info { font-size: 14px; color: #ddd; font-weight: bold; }
        .btn-icon { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; border-radius: 5px; padding: 5px 10px; font-size: 14px; cursor: pointer; }

        #start-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .btn-upload { background-color: var(--accent); color: #000; border: none; padding: 15px 40px; font-size: 18px; font-weight: bold; border-radius: 50px; box-shadow: 0 0 20px rgba(100, 200, 255, 0.4); margin-bottom: 20px; cursor: pointer;}
        #loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none; z-index: 90; font-size: 18px; color: var(--accent); background: rgba(0,0,0,0.8); padding: 20px; border-radius: 10px; }

        #zoom-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 999; display: none; overflow: hidden; }
        #zoom-container { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
        #zoom-img { max-width: 100%; max-height: 100%; object-fit: contain; }
        #zoom-close-btn { position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.5); color: white; border: 2px solid white; width: 40px; height: 40px; border-radius: 50%; font-size: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 1000; }
        
        /* ìƒë‹¨ ë²„íŠ¼ ê·¸ë£¹ */
        .top-btn-group { position: absolute; top: 10px; right: 10px; z-index: 101; display: none; gap: 10px; }
        .top-btn { border: none; color: white; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 13px; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        #btn-export { background: #6f42c1; } 
        #btn-reset { background: #ff4444; } 
    </style>
</head>
<body>

    <div class="top-btn-group" id="top-buttons">
        <button id="btn-export" class="top-btn">ğŸ“˜ ì´ë¶ íŒŒì¼ë¡œ ì €ì¥ (ê³µìœ ìš©)</button>
        <button id="btn-reset" class="top-btn">â†» ì´ˆê¸°í™”</button>
    </div>

    <div id="start-screen">
        <h2 style="color:var(--accent); margin-bottom: 10px;">Smart Library</h2>
        <p style="color:#888; margin-bottom: 40px; font-size: 14px;">PDFë¥¼ ì„ íƒí•˜ë©´ ìë™ìœ¼ë¡œ ë³€í™˜ë©ë‹ˆë‹¤.</p>
        <input type="file" id="file-input" accept="application/pdf" style="display: none;">
        <button class="btn-upload" onclick="document.getElementById('file-input').click()">PDF ë¶ˆëŸ¬ì˜¤ê¸°</button>
    </div>

    <div id="loading">ë¡œë”© ì¤‘...</div>

    <div id="book-container">
        <div id="flipbook"></div>
    </div>

    <div id="ui-controls">
        <div class="control-row" style="margin-bottom: 10px;">
            <span id="page-info">0 / 0</span>
            <button class="btn-icon" id="btn-fullscreen">ì „ì²´í™”ë©´</button>
        </div>
        <div class="control-row">
            <input type="range" id="page-slider" min="0" max="100" value="0">
        </div>
    </div>

    <div id="zoom-layer">
        <div id="zoom-close-btn">âœ•</div>
        <div id="zoom-container"><img id="zoom-img" src="" alt="Zoom Image"></div>
    </div>

    <script>
        // === [PWA] ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡ (ì˜µì…˜) ===
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').catch(err => console.log('SW Fail:', err));
        }

        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // === [DB] IndexedDB ì„¤ì • ===
        const DB_NAME = "EbookDB"; const STORE_NAME = "files";
        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, 1);
                request.onupgradeneeded = (e) => e.target.result.createObjectStore(STORE_NAME);
                request.onsuccess = (e) => resolve(e.target.result);
                request.onerror = (e) => reject(e);
            });
        }
        async function saveFileToDB(fileData) {
            const db = await openDB();
            const tx = db.transaction(STORE_NAME, "readwrite");
            tx.objectStore(STORE_NAME).put(fileData, "currentBook");
            return new Promise((resolve) => tx.oncomplete = resolve);
        }
        async function loadFileFromDB() {
            const db = await openDB();
            const tx = db.transaction(STORE_NAME, "readonly");
            const req = tx.objectStore(STORE_NAME).get("currentBook");
            return new Promise((resolve) => { req.onsuccess = () => resolve(req.result); });
        }
        async function clearDB() {
            const db = await openDB();
            const tx = db.transaction(STORE_NAME, "readwrite");
            tx.objectStore(STORE_NAME).delete("currentBook");
            return new Promise((resolve) => tx.oncomplete = resolve);
        }

        // === [Main] ===
        const els = {
            fileInput: document.getElementById('file-input'),
            startScreen: document.getElementById('start-screen'),
            loading: document.getElementById('loading'),
            bookContainer: document.getElementById('book-container'),
            flipbook: document.getElementById('flipbook'),
            ui: document.getElementById('ui-controls'),
            slider: document.getElementById('page-slider'),
            pageInfo: document.getElementById('page-info'),
            btnFullscreen: document.getElementById('btn-fullscreen'),
            zoomLayer: document.getElementById('zoom-layer'),
            zoomImg: document.getElementById('zoom-img'),
            zoomClose: document.getElementById('zoom-close-btn'),
            topButtons: document.getElementById('top-buttons'),
            btnReset: document.getElementById('btn-reset'),
            btnExport: document.getElementById('btn-export')
        };

        let allPages = [], pageFlip, totalPages = 0, pdfDoc = null, zoomInstance = null, lastTap = 0, pdfOriginalRatio = 0.7;
        let currentPDFData = null; // ì›ë³¸ ë°ì´í„° ë³´ê´€ìš©

        // 1. [ìˆ˜ì •ë¨] ì•± ì‹œì‘ ì‹œ DB ë¡œë“œ
        window.addEventListener('DOMContentLoaded', async () => {
            const savedData = await loadFileFromDB();
            if (savedData) {
                // [ì¤‘ìš”] DBì—ì„œ ë¶ˆëŸ¬ì˜¨ ë°ì´í„°ë¥¼ ë³€ìˆ˜ì— ì €ì¥
                currentPDFData = savedData; 
                
                els.startScreen.style.display = 'none';
                els.loading.style.display = 'block';
                els.topButtons.style.display = 'flex';
                
                // [ì¤‘ìš”] ë·°ì–´ì—ëŠ” 'ë³µì‚¬ë³¸'ì„ ë„˜ê²¨ì„œ ì›ë³¸(currentPDFData)ì´ ì†ìƒë˜ì§€ ì•Šê²Œ í•¨
                await loadPDF(savedData.slice(0)); 
            }
        });

        // 2. [ìˆ˜ì •ë¨] íŒŒì¼ ì„ íƒ ì‹œ ì²˜ë¦¬
        els.fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const data = await file.arrayBuffer();
            
            // [ì¤‘ìš”] ì›ë³¸ ë³´ê´€ (DB ì €ì¥ ë° ë‚´ë³´ë‚´ê¸°ìš©)
            currentPDFData = data; 
            await saveFileToDB(data);

            els.startScreen.style.display = 'none';
            els.loading.style.display = 'block';
            els.topButtons.style.display = 'flex';
            
            // [ì¤‘ìš”] ë·°ì–´ì—ëŠ” ë³µì‚¬ë³¸ ì „ë‹¬
            await loadPDF(data.slice(0)); 
        });

        els.btnReset.addEventListener('click', async () => {
            if(confirm("ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                await clearDB();
                location.reload();
            }
        });

        // 3. ì´ë¶ íŒŒì¼ ìƒì„± (ì•ˆì „ì¥ì¹˜ ì¶”ê°€)
        els.btnExport.addEventListener('click', () => {
            // ë°ì´í„° ì¡´ì¬ ì—¬ë¶€ ë° í¬ê¸°(0ë°”ì´íŠ¸ì¸ì§€) í™•ì¸
            if (!currentPDFData || currentPDFData.byteLength === 0) {
                alert("ë‚´ë³´ë‚¼ PDF ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ì„ ë‹¤ì‹œ ì—´ì–´ì£¼ì„¸ìš”.");
                return;
            }

            els.loading.style.display = 'block';
            els.loading.innerText = "ì´ë¶ íŒŒì¼ ìƒì„± ì¤‘... (íŒŒì¼ í¬ê¸°ì— ë”°ë¼ ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤)";

            setTimeout(async () => {
                try {
                    const base64PDF = await arrayBufferToBase64(currentPDFData);
                    downloadPortableHTML(base64PDF);
                } catch(e) {
                    alert("ìƒì„± ì‹¤íŒ¨: " + e.message);
                }
                els.loading.style.display = 'none';
            }, 100);
        });

        function arrayBufferToBase64(buffer) {
            return new Promise((resolve, reject) => {
                const blob = new Blob([buffer], { type: 'application/pdf' });
                const reader = new FileReader();
                reader.onloadend = () => {
                    if(reader.result) resolve(reader.result.split(',')[1]);
                    else reject(new Error("ë³€í™˜ ì‹¤íŒ¨"));
                };
                reader.readAsDataURL(blob);
            });
        }

        // íœ´ëŒ€ìš© HTML íŒŒì¼ ìƒì„± ë° ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
        function downloadPortableHTML(base64Data) {
            const htmlContent = `<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My E-Book</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"><\/script>
    <script src="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.min.js"><\/script>
    <script src="https://unpkg.com/@panzoom/panzoom@4.5.1/dist/panzoom.min.js"><\/script>
    <style>
        ${document.querySelector('style').innerHTML}
        #start-screen { display: none !important; }
        .top-btn-group { display: none !important; }
    </style>
</head>
<body>
    <div id="loading">ì±…ì„ í¼ì¹˜ëŠ” ì¤‘...</div>
    <div id="book-container"><div id="flipbook"></div></div>
    <div id="ui-controls">
        <div class="control-row" style="margin-bottom:10px;">
            <span id="page-info">0 / 0</span>
            <button class="btn-icon" id="btn-fullscreen">ì „ì²´í™”ë©´</button>
        </div>
        <div class="control-row"><input type="range" id="page-slider" min="0" max="100" value="0"></div>
    </div>
    <div id="zoom-layer">
        <div id="zoom-close-btn">âœ•</div>
        <div id="zoom-container"><img id="zoom-img" src=""></div>
    </div>
    <script>
        const embeddedPDF = "${base64Data}";
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        window.addEventListener('DOMContentLoaded', () => {
            if(!embeddedPDF) { alert("PDF ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤."); return; }
            const pdfData = base64ToArrayBuffer(embeddedPDF);
            loadPDF(pdfData);
        });

        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) { bytes[i] = binaryString.charCodeAt(i); }
            return bytes.buffer;
        }

        const els = {
            loading: document.getElementById('loading'),
            bookContainer: document.getElementById('book-container'),
            flipbook: document.getElementById('flipbook'),
            ui: document.getElementById('ui-controls'),
            slider: document.getElementById('page-slider'),
            pageInfo: document.getElementById('page-info'),
            btnFullscreen: document.getElementById('btn-fullscreen'),
            zoomLayer: document.getElementById('zoom-layer'),
            zoomImg: document.getElementById('zoom-img'),
            zoomClose: document.getElementById('zoom-close-btn')
        };
        
        let allPages=[], pageFlip, totalPages=0, lastTap=0, zoomInstance=null, pdfOriginalRatio=0.7;

        function splitCanvas(original) {
            const w=original.width, h=original.height, halfW=Math.floor(w/2);
            const l=document.createElement('canvas'), r=document.createElement('canvas');
            l.width=halfW; l.height=h; r.width=halfW; r.height=h;
            l.getContext('2d').drawImage(original,0,0,halfW,h,0,0,halfW,h);
            r.getContext('2d').drawImage(original,halfW,0,halfW,h,0,0,halfW,h);
            return [l,r];
        }

        async function loadPDF(data) {
            try {
                const pdfDoc = await pdfjsLib.getDocument(data).promise;
                const fragment = document.createDocumentFragment();
                const firstPage = await pdfDoc.getPage(1);
                const firstViewport = firstPage.getViewport({scale:1.0});
                pdfOriginalRatio = (firstViewport.width>firstViewport.height*1.1)?(firstViewport.width/2)/firstViewport.height : firstViewport.width/firstViewport.height;

                for(let i=1; i<=pdfDoc.numPages; i++){
                    const page = await pdfDoc.getPage(i);
                    const viewport = page.getViewport({scale:1.5});
                    const canvas = document.createElement('canvas');
                    canvas.width=viewport.width; canvas.height=viewport.height;
                    await page.render({canvasContext:canvas.getContext('2d'), viewport}).promise;
                    
                    if(viewport.width > viewport.height*1.1){
                        const [l,r] = splitCanvas(canvas);
                        l.classList.add('page-canvas'); r.classList.add('page-canvas');
                        l.dataset.pdfIdx=i; r.dataset.pdfIdx=i;
                        allPages.push(l); allPages.push(r);
                        fragment.appendChild(l); fragment.appendChild(r);
                    } else {
                        canvas.classList.add('page-canvas'); canvas.dataset.pdfIdx=i;
                        allPages.push(canvas); fragment.appendChild(canvas);
                    }
                    els.loading.innerText = 'ë³€í™˜ ì¤‘... ('+i+'/'+pdfDoc.numPages+')';
                }
                els.flipbook.appendChild(fragment);
                els.loading.style.display='none';
                initFlipBook();
            } catch(e) { alert('ì˜¤ë¥˜: '+e.message); }
        }

        function initFlipBook() {
            const isFullscreen = document.fullscreenElement !== null;
            const padding = isFullscreen ? 20 : 40; 
            const containerW = els.bookContainer.clientWidth - padding;
            const containerH = els.bookContainer.clientHeight - padding;
            let bookH=containerH, bookW=bookH*pdfOriginalRatio;
            if(bookW>containerW){ bookW=containerW; bookH=bookW/pdfOriginalRatio; }
            bookW=Math.floor(bookW); bookH=Math.floor(bookH);

            pageFlip = new St.PageFlip(els.flipbook, { width:bookW, height:bookH, size:'fixed', usePortrait:true, maxShadowOpacity:0.5, autoSize:true });
            pageFlip.loadFromHTML(allPages);
            totalPages = pageFlip.getPageCount();
            els.slider.max = totalPages-1;

            pageFlip.on('flip', (e)=>{ els.pageInfo.innerText = (e.data+1)+' / '+totalPages; els.slider.value=e.data; });
            els.slider.addEventListener('input', (e)=>pageFlip.flip(parseInt(e.target.value)));
            els.bookContainer.addEventListener('touchend', handleTouch);
            els.bookContainer.addEventListener('click', handleTouch);
        }

        function handleTouch(e) {
            if (e.target.closest('#ui-controls')) return;
            const currentTime = new Date().getTime();
            if (currentTime - lastTap < 300 && currentTime - lastTap > 0) { openZoomView(); e.preventDefault(); } 
            else { setTimeout(() => { if (new Date().getTime() - lastTap > 350) els.ui.classList.toggle('hidden'); }, 350); }
            lastTap = currentTime;
        }

        function openZoomView() {
            const currentIdx = pageFlip.getCurrentPageIndex();
            const currentPage = allPages[currentIdx];
            if (currentPage) {
                els.zoomImg.src = currentPage.toDataURL();
                els.zoomLayer.style.display = 'block';
                if (zoomInstance) zoomInstance.dispose();
                zoomInstance = Panzoom(document.getElementById('zoom-container'), { maxScale: 5, minScale: 1, contain: 'outside' });
                document.getElementById('zoom-container').addEventListener('wheel', zoomInstance.zoomWithWheel);
            }
        }
        els.zoomClose.addEventListener('click', () => { els.zoomLayer.style.display = 'none'; if(zoomInstance) zoomInstance.dispose(); });
        els.btnFullscreen.addEventListener('click', () => {
            if (!document.fullscreenElement) { document.documentElement.requestFullscreen(); els.btnFullscreen.innerText = "ì¶•ì†Œ"; }
            else { if(document.exitFullscreen) document.exitFullscreen(); els.btnFullscreen.innerText = "ì „ì²´í™”ë©´"; }
        });
        document.addEventListener('fullscreenchange', () => { setTimeout(() => { 
            if(pageFlip){ 
                const idx=pageFlip.getCurrentPageIndex(); pageFlip.destroy(); 
                els.flipbook.innerHTML=''; allPages.forEach(p=>els.flipbook.appendChild(p)); 
                initFlipBook(); pageFlip.turnToPage(idx); 
            }
        }, 100); });
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => { 
                 if(pageFlip){ 
                    const idx=pageFlip.getCurrentPageIndex(); pageFlip.destroy(); 
                    els.flipbook.innerHTML=''; allPages.forEach(p=>els.flipbook.appendChild(p)); 
                    initFlipBook(); pageFlip.turnToPage(idx); 
                }
            }, 300);
        });
    <\/script>
</body>
</html>`;

            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'My_Portable_Book.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function splitCanvas(original) {
            const w = original.width, h = original.height, halfW = Math.floor(w / 2);
            const l = document.createElement('canvas'), r = document.createElement('canvas');
            l.width = halfW; l.height = h; r.width = halfW; r.height = h;
            l.getContext('2d').drawImage(original, 0, 0, halfW, h, 0, 0, halfW, h);
            r.getContext('2d').drawImage(original, halfW, 0, halfW, h, 0, 0, halfW, h);
            return [l, r];
        }

        async function loadPDF(data) {
            try {
                allPages = []; 
                els.flipbook.innerHTML = ""; 
                pdfDoc = await pdfjsLib.getDocument(data).promise;
                const fragment = document.createDocumentFragment();
                const firstPage = await pdfDoc.getPage(1);
                const firstViewport = firstPage.getViewport({ scale: 1.0 });
                pdfOriginalRatio = (firstViewport.width > firstViewport.height * 1.1) ? (firstViewport.width / 2) / firstViewport.height : firstViewport.width / firstViewport.height;

                for (let i = 1; i <= pdfDoc.numPages; i++) {
                    const page = await pdfDoc.getPage(i);
                    const viewport = page.getViewport({ scale: 1.5 }); 
                    const canvas = document.createElement('canvas');
                    canvas.width = viewport.width; canvas.height = viewport.height;
                    await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;

                    if (viewport.width > viewport.height * 1.1) {
                        const [l, r] = splitCanvas(canvas);
                        l.classList.add('page-canvas'); r.classList.add('page-canvas');
                        l.dataset.pdfIdx = i; r.dataset.pdfIdx = i; 
                        allPages.push(l); allPages.push(r); fragment.appendChild(l); fragment.appendChild(r);
                    } else {
                        canvas.classList.add('page-canvas'); canvas.dataset.pdfIdx = i;
                        allPages.push(canvas); fragment.appendChild(canvas);
                    }
                    els.loading.innerText = `ë³€í™˜ ì¤‘... (${i}/${pdfDoc.numPages})`;
                }
                els.flipbook.appendChild(fragment);
                els.loading.style.display = 'none';
                initFlipBook();
            } catch (e) {
                console.error(e);
                alert("ì˜¤ë¥˜: " + e.message);
                location.reload();
            }
        }

        function initFlipBook() {
            const isFullscreen = document.fullscreenElement !== null;
            const padding = isFullscreen ? 20 : 40; 
            const containerW = els.bookContainer.clientWidth - padding;
            const containerH = els.bookContainer.clientHeight - padding;
            let bookH = containerH;
            let bookW = bookH * pdfOriginalRatio;
            if (bookW > containerW) { bookW = containerW; bookH = bookW / pdfOriginalRatio; }
            bookW = Math.floor(bookW); bookH = Math.floor(bookH);

            pageFlip = new St.PageFlip(els.flipbook, { width: bookW, height: bookH, size: "fixed", usePortrait: true, maxShadowOpacity: 0.5, autoSize: true });
            pageFlip.loadFromHTML(allPages);
            totalPages = pageFlip.getPageCount();
            els.slider.max = totalPages - 1;
            pageFlip.on('flip', (e) => { els.pageInfo.innerText = `${e.data + 1} / ${totalPages}`; els.slider.value = e.data; });
            els.slider.addEventListener('input', (e) => pageFlip.flip(parseInt(e.target.value)));
            els.bookContainer.addEventListener('touchend', handleTouch);
            els.bookContainer.addEventListener('click', handleTouch);
        }

        function handleTouch(e) {
            if (e.target.closest('#ui-controls') || e.target.closest('#top-buttons')) return;
            const currentTime = new Date().getTime();
            if (currentTime - lastTap < 300 && currentTime - lastTap > 0) { openZoomView(); e.preventDefault(); } 
            else { setTimeout(() => { if (new Date().getTime() - lastTap > 350) els.ui.classList.toggle('hidden'); }, 350); }
            lastTap = currentTime;
        }

        function openZoomView() {
            const currentIdx = pageFlip.getCurrentPageIndex();
            const currentPage = allPages[currentIdx];
            if (currentPage) {
                els.zoomImg.src = currentPage.toDataURL();
                els.zoomLayer.style.display = 'block';
                if (zoomInstance) zoomInstance.dispose();
                zoomInstance = Panzoom(document.getElementById('zoom-container'), { maxScale: 5, minScale: 1, contain: 'outside' });
                document.getElementById('zoom-container').addEventListener('wheel', zoomInstance.zoomWithWheel);
            }
        }
        els.zoomClose.addEventListener('click', () => { els.zoomLayer.style.display = 'none'; if(zoomInstance) zoomInstance.dispose(); });
        els.btnFullscreen.addEventListener('click', () => {
            if (!document.fullscreenElement) { document.documentElement.requestFullscreen(); els.btnFullscreen.innerText = "ì¶•ì†Œ"; }
            else { if(document.exitFullscreen) document.exitFullscreen(); els.btnFullscreen.innerText = "ì „ì²´í™”ë©´"; }
        });
        document.addEventListener('fullscreenchange', () => { setTimeout(() => { 
            if(pageFlip){ const idx=pageFlip.getCurrentPageIndex(); pageFlip.destroy(); els.flipbook.innerHTML=''; allPages.forEach(p=>els.flipbook.appendChild(p)); initFlipBook(); pageFlip.turnToPage(idx); }
        }, 100); });
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => { 
                if(pageFlip){ const idx=pageFlip.getCurrentPageIndex(); pageFlip.destroy(); els.flipbook.innerHTML=''; allPages.forEach(p=>els.flipbook.appendChild(p)); initFlipBook(); pageFlip.turnToPage(idx); }
            }, 300);
        });
    </script>
</body>
</html>
